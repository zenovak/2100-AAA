<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Function Registry Editor</title>
    <style>
        :root {
            --primary: #4a6bff;
            --secondary: #8c52ff;
            --dark: #2a3142;
            --light: #f0f2f5;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray: #9ca3af;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            padding: 2rem;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
        }

        h1, h2, h3 {
            margin-bottom: 1rem;
            color: var(--dark);
        }

        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .registry-list {
            max-height: calc(100vh - 150px);
            overflow-y: auto;
        }

        .registry-item {
            padding: 0.75rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.5rem;
            background-color: white;
            border: 1px solid #e5e7eb;
        }

        .registry-item:hover {
            background-color: rgba(74, 107, 255, 0.05);
            border-color: var(--primary);
        }

        .registry-item.active {
            background-color: rgba(74, 107, 255, 0.1);
            border-color: var(--primary);
            font-weight: 500;
        }

        .details-panel {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 1.5rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--primary);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background-color: white;
            font-size: 0.875rem;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        button {
            padding: 0.75rem 1.5rem;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background-color: #3a5ae2;
        }

        button.secondary {
            background-color: white;
            border: 1px solid #e5e7eb;
            color: var(--dark);
        }

        button.secondary:hover {
            background-color: #f9fafb;
            border-color: var(--gray);
        }

        button.danger {
            background-color: var(--danger);
        }

        button.danger:hover {
            background-color: #dc2626;
        }

        .actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .field-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: flex-end;
        }

        .field-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }

        .json-display {
            background-color: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre;
            overflow-x: auto;
            max-height: 70vh;
            overflow-y: auto;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }

        .badge-blue {
            background-color: rgba(74, 107, 255, 0.1);
            color: var(--primary);
        }

        .badge-purple {
            background-color: rgba(140, 82, 255, 0.1);
            color: var(--secondary);
        }

        .prompt-chain-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .prompt-chain-item h4 {
            margin-bottom: 1rem;
        }

        .remove-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0.25rem;
        }

        .drag-handle {
            cursor: grab;
            padding: 0.25rem 0.5rem;
            background-color: #f3f4f6;
            border-radius: 4px;
            margin-right: 0.5rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray);
        }

        .empty-state p {
            margin-bottom: 1.5rem;
        }

        .prompt-preview-container {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f8fafc;
            border-radius: 6px;
            border: 1px dashed #cbd5e1;
        }

        .preview-box {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background-color: white;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
        }

        .quick-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .search-bar {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .search-bar input {
            padding: 0.5rem 0.75rem;
            width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="card">
                <div class="header-actions">
                    <h2>Function Registry</h2>
                    <div class="search-bar">
                        <input type="text" id="search-input" placeholder="Search...">
                    </div>
                </div>
                <button id="add-new-btn" class="secondary" style="width: 100%; margin-bottom: 1rem;">
                    + Add New Function
                </button>
                <div class="registry-list" id="registry-list">
                    <!-- Function items will be populated here -->
                </div>
            </div>
        </div>

        <div class="details-panel">
            <div class="card" id="function-details">
                <div class="empty-state" id="empty-state">
                    <h3>No Function Selected</h3>
                    <p>Select a function from the list to view its details, or create a new one.</p>
                    <button id="create-new-btn">Create New Function</button>
                </div>

                <div id="function-editor" style="display: none;">
                    <div class="tabs">
                        <div class="tab active" data-tab="basic">Basic Information</div>
                        <div class="tab" data-tab="fields">Fields</div>
                        <div class="tab" data-tab="promptChain">Prompt Chain</div>
                        <div class="tab" data-tab="typeSpecific">Type-Specific</div>
                        <div class="tab" data-tab="preview">JSON Preview</div>
                    </div>

                    <div class="tab-content active" data-tab-content="basic">
                        <h3>Basic Information</h3>
                        <div class="form-group">
                            <label for="function-id">Function ID</label>
                            <input type="text" id="function-id" placeholder="e.g., newsletter, article, poem">
                        </div>
                        <div class="form-group">
                            <label for="function-url">URL Path</label>
                            <input type="text" id="function-url" placeholder="e.g., /editor/newsletter">
                        </div>
                        <div class="form-group">
                            <label for="multi-prompt">Multi-Prompt</label>
                            <select id="multi-prompt">
                                <option value="true">True</option>
                                <option value="false">False</option>
                            </select>
                        </div>
                    </div>
                    <div class="tab-content" data-tab-content="fields">
                        <h3>Fields</h3>
                        <p>Define the input fields for your function.</p>
                        
                        <div id="fields-container">
                            <!-- Fields will be added here -->
                        </div>

                        <button id="add-field-btn" class="secondary">+ Add Field</button>

                        <h3 style="margin-top: 2rem;">Default Values</h3>
                        <div id="defaults-container">
                            <!-- Default values will be added here -->
                        </div>
                    </div>

                    <div class="tab-content" data-tab-content="promptChain">
                        <h3>Prompt Chain</h3>
                        <p>Define the sequence of prompts for this function.</p>
                        
                        <div id="prompt-chain-container">
                            <!-- Prompt chain items will be added here -->
                        </div>

                        <div class="quick-actions">
                            <button id="add-prompt-btn" class="secondary">+ Add Prompt</button>
                            <button id="preview-all-prompts" class="secondary">Preview All Prompts</button>
                        </div>
                    </div>

                    <div class="tab-content" data-tab-content="typeSpecific">
                        <h3>Type-Specific Prompts</h3>
                        <p>Define special prompts for specific types.</p>
                        
                        <div class="form-group">
                            <label for="type-selector">Select Type</label>
                            <select id="type-selector">
                                <!-- Options will be populated based on field with 'type' -->
                                <option value="">Select a type...</option>
                            </select>
                        </div>

                        <div id="type-specific-container">
                            <!-- Type-specific prompts will be added here -->
                        </div>

                        <button id="add-type-prompt-btn" class="secondary">+ Add Type-Specific Prompt</button>
                    </div>

                    <div class="tab-content" data-tab-content="preview">
                        <h3>JSON Preview</h3>
                        <div class="json-display" id="json-preview">
                            <!-- JSON will be displayed here -->
                        </div>
                    </div>

                    <div class="actions" style="margin-top: 1.5rem;">
                        <button id="generate-docs-btn" class="secondary">Generate Docs</button>
                        <button id="import-btn" class="secondary">Import Registry</button>
                        <button id="export-btn" class="secondary">Export Registry</button>
                        <button id="delete-btn" class="danger">Delete</button>
                        <button id="save-btn">Save Function</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Field Template (hidden) -->
    <template id="field-template">
        <div class="field-row">
            <div class="form-group">
                <label for="field-id">Field ID</label>
                <input type="text" class="field-id" placeholder="e.g., title, genre">
            </div>
            <div class="form-group">
                <label for="field-label">Label</label>
                <input type="text" class="field-label" placeholder="e.g., Title, Genre">
            </div>
            <div class="form-group">
                <label for="field-type">Type</label>
                <select class="field-type">
                    <option value="text">Text</option>
                    <option value="select">Select</option>
                    <option value="textarea">Text Area</option>
                </select>
            </div>
            <button class="btn-sm danger remove-field">Remove</button>
        </div>
        <div class="field-options" style="display: none; margin-bottom: 1.5rem;">
            <label>Options (for Select type)</label>
            <div class="options-container">
                <!-- Options will be added here -->
            </div>
            <button class="btn-sm secondary add-option">+ Add Option</button>
        </div>
    </template>

    <!-- Option Template (hidden) -->
    <template id="option-template">
        <div class="field-row">
            <div class="form-group">
                <input type="text" class="option-value" placeholder="Option value">
            </div>
            <button class="btn-sm danger remove-option">Remove</button>
        </div>
    </template>

    <!-- Prompt Template (hidden) -->
    <template id="prompt-template">
        <div class="prompt-chain-item">
            <span class="drag-handle">≡</span>
            <h4>Prompt Item</h4>
            <button class="remove-btn">×</button>
            
            <div class="form-group">
                <label for="prompt-id">Prompt ID</label>
                <input type="text" class="prompt-id" placeholder="e.g., introduction, summary">
            </div>
            <div class="form-group">
                <label for="prompt-label">Label</label>
                <input type="text" class="prompt-label" placeholder="e.g., Introduction, Summary">
            </div>
            <div class="form-group">
                <label for="prompt-system">System Message</label>
                <textarea class="prompt-system" placeholder="System message with {variables}"></textarea>
            </div>
            <div class="form-group">
                <label for="prompt-user">User Message</label>
                <textarea class="prompt-user" placeholder="User message with {variables}"></textarea>
            </div>
            <div class="form-group">
                <label for="prompt-format">Format Template</label>
                <input type="text" class="prompt-format" placeholder="e.g., Output format: {content}">
            </div>
            <button class="preview-prompt-btn secondary btn-sm">Preview Prompt</button>
        </div>
    </template>

    <!-- Type-Specific Prompt Template (hidden) -->
    <template id="type-prompt-template">
        <div class="prompt-chain-item">
            <h4>Type-Specific Prompt</h4>
            <button class="remove-btn">×</button>
            
            <div class="form-group">
                <label>Prompt ID</label>
                <input type="text" class="type-prompt-id" placeholder="e.g., specialFeature">
            </div>
            <div class="form-group">
                <label>Label</label>
                <input type="text" class="type-prompt-label" placeholder="e.g., Special Feature">
            </div>
            <div class="form-group">
                <label>System Message</label>
                <textarea class="type-prompt-system" placeholder="System message for this type"></textarea>
            </div>
            <div class="form-group">
                <label>User Message</label>
                <textarea class="type-prompt-user" placeholder="User message for this type"></textarea>
            </div>
            <div class="form-group">
                <label>Format Template</label>
                <input type="text" class="type-prompt-format" placeholder="e.g., Special format: {content}">
            </div>
        </div>
    </template>

    <script>
        // Sample data
        let functionsRegistry = JSON.parse(`{
            "movie-script": {
                "url": "/editor/movie-script",
                "multiPrompt": true,
                "fields": [
                    {
                        "id": "genre",
                        "label": "Genre",
                        "type": "select",
                        "options": [
                            "Action",
                            "Drama",
                            "Comedy",
                            "Science Fiction",
                            "Horror",
                            "Romance",
                            "Thriller",
                            "Adventure",
                            "Mystery",
                            "Fantasy"
                        ]
                    },
                    {
                        "id": "title",
                        "label": "Movie Title",
                        "type": "text"
                    }
                ],
                "defaults": {
                    "genre": "Drama",
                    "title": ""
                },
                "promptChain": [
                    {
                        "id": "synopsis",
                        "label": "Synopsis",
                        "system": "You are a story development expert creating a synopsis for a {genre} film.",
                        "user": "Write a synopsis for '{title}'",
                        "format": "Synopsis:\\n{content}"
                    }
                ]
            },
            "newsletter": {
                "url": "/editor/newsletter",
                "multiPrompt": true,
                "fields": [
                    {
                        "id": "newsletterType",
                        "label": "Newsletter Type",
                        "type": "select",
                        "options": [
                            "Company Update",
                            "Industry News",
                            "Product Focused"
                        ]
                    }
                ],
                "defaults": {
                    "newsletterType": "Company Update"
                },
                "promptChain": []
            }
        }`);

        // Current function being edited
        let currentFunction = null;

      // DOM Elements
        const registryListEl = document.getElementById('registry-list');
        const emptyStateEl = document.getElementById('empty-state');
        const functionEditorEl = document.getElementById('function-editor');
        const addNewBtnEl = document.getElementById('add-new-btn');
        const createNewBtnEl = document.getElementById('create-new-btn');
        const functionIdEl = document.getElementById('function-id');
        const functionUrlEl = document.getElementById('function-url');
        const multiPromptEl = document.getElementById('multi-prompt');
        const fieldsContainerEl = document.getElementById('fields-container');
        const defaultsContainerEl = document.getElementById('defaults-container');
        const addFieldBtnEl = document.getElementById('add-field-btn');
        const promptChainContainerEl = document.getElementById('prompt-chain-container');
        const addPromptBtnEl = document.getElementById('add-prompt-btn');
        const previewAllPromptsBtn = document.getElementById('preview-all-prompts');
        const typeSpecificContainerEl = document.getElementById('type-specific-container');
        const addTypePromptBtnEl = document.getElementById('add-type-prompt-btn');
        const typeSelectorEl = document.getElementById('type-selector');
        const jsonPreviewEl = document.getElementById('json-preview');
        const saveBtnEl = document.getElementById('save-btn');
        const deleteBtnEl = document.getElementById('delete-btn');
        const exportBtnEl = document.getElementById('export-btn');
        const importBtnEl = document.getElementById('import-btn');
        const generateDocsBtnEl = document.getElementById('generate-docs-btn');
        const searchInputEl = document.getElementById('search-input');
        const tabs = document.querySelectorAll('.tab');

        // Initialize the app
        function init() {
            renderFunctionList();
            setupEventListeners();
        }

        // Render the list of functions
        function renderFunctionList() {
            registryListEl.innerHTML = '';
            
            Object.keys(functionsRegistry).forEach(functionId => {
                const func = functionsRegistry[functionId];
                const item = document.createElement('div');
                item.className = 'registry-item';
                item.dataset.id = functionId;
                
                let badgeText = '';
                if (func.multiPrompt) {
                    badgeText = '<span class="badge badge-blue">Multi-Prompt</span>';
                }
                
                item.innerHTML = `
                    ${functionId} ${badgeText}
                `;
                
                item.addEventListener('click', () => {
                    document.querySelectorAll('.registry-item').forEach(el => {
                        el.classList.remove('active');
                    });
                    item.classList.add('active');
                    loadFunctionDetails(functionId);
                });
                
                registryListEl.appendChild(item);
            });
        }

        // Search functions
        function searchFunctions(query) {
            const normalizedQuery = query.toLowerCase().trim();
            
            document.querySelectorAll('.registry-item').forEach(item => {
                const functionId = item.dataset.id.toLowerCase();
                if (functionId.includes(normalizedQuery) || !normalizedQuery) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Load function details into the editor
        function loadFunctionDetails(functionId) {
            currentFunction = functionsRegistry[functionId];
            currentFunction.id = functionId;
            
            // Show editor, hide empty state
            emptyStateEl.style.display = 'none';
            functionEditorEl.style.display = 'block';
            
            // Populate basic info
            functionIdEl.value = functionId;
            functionUrlEl.value = currentFunction.url || '';
            multiPromptEl.value = currentFunction.multiPrompt ? 'true' : 'false';
            
            // Populate fields
            renderFields();
            
            // Populate prompt chain
            renderPromptChain();
            
            // Update type selector
            updateTypeSelector();
            
            // Update JSON preview
            updateJsonPreview();
            
            // Switch to first tab
            tabs[0].click();
        }

        // Render fields
        function renderFields() {
            fieldsContainerEl.innerHTML = '';
            defaultsContainerEl.innerHTML = '';
            
            if (!currentFunction.fields) {
                currentFunction.fields = [];
            }
            
            currentFunction.fields.forEach(field => {
                const fieldEl = addFieldUI();
                
                // Populate field values
                fieldEl.querySelector('.field-id').value = field.id || '';
                fieldEl.querySelector('.field-label').value = field.label || '';
                fieldEl.querySelector('.field-type').value = field.type || 'text';
                
                // Handle options for select fields
                if (field.type === 'select' && field.options) {
                    const optionsContainer = fieldEl.querySelector('.options-container');
                    fieldEl.querySelector('.field-options').style.display = 'block';
                    
                    field.options.forEach(option => {
                        const optionEl = addOptionUI(optionsContainer);
                        optionEl.querySelector('.option-value').value = option;
                    });
                }
            });
            
            // Render defaults
            if (currentFunction.defaults) {
                Object.keys(currentFunction.defaults).forEach(fieldId => {
                    const defaultValue = currentFunction.defaults[fieldId];
                    const fieldObj = currentFunction.fields.find(f => f.id === fieldId);
                    
                    const defaultEl = document.createElement('div');
                    defaultEl.className = 'form-group';
                    defaultEl.innerHTML = `
                        <label for="default-${fieldId}">${fieldId} Default Value</label>
                        ${fieldObj && fieldObj.type === 'select' 
                            ? `<select id="default-${fieldId}" class="default-value" data-field="${fieldId}">
                                ${fieldObj.options.map(opt => `
                                    <option value="${opt}" ${defaultValue === opt ? 'selected' : ''}>${opt}</option>
                                `).join('')}
                               </select>`
                            : `<input type="text" id="default-${fieldId}" class="default-value" data-field="${fieldId}" value="${defaultValue}">`
                        }
                    `;
                    
                    defaultsContainerEl.appendChild(defaultEl);
                });
            }
        }

        // Render prompt chain
        function renderPromptChain() {
            promptChainContainerEl.innerHTML = '';
            
            if (!currentFunction.promptChain) {
                currentFunction.promptChain = [];
            }
            
            currentFunction.promptChain.forEach(prompt => {
                const promptEl = addPromptUI();
                
                // Populate prompt values
                promptEl.querySelector('.prompt-id').value = prompt.id || '';
                promptEl.querySelector('.prompt-label').value = prompt.label || '';
                promptEl.querySelector('.prompt-system').value = prompt.system || '';
                promptEl.querySelector('.prompt-user').value = prompt.user || '';
                promptEl.querySelector('.prompt-format').value = prompt.format || '';
                
                // Add preview button event listener
                promptEl.querySelector('.preview-prompt-btn').addEventListener('click', () => {
                    previewRenderedPrompt(promptEl);
                });
            });
        }

        // Add field UI element
        function addFieldUI() {
            const template = document.getElementById('field-template');
            const fieldEl = template.content.cloneNode(true);
            const container = fieldsContainerEl.appendChild(fieldEl).querySelector('.field-row').parentNode;
            
            // Add event listeners
            const typeSelect = container.querySelector('.field-type');
            const optionsContainer = container.querySelector('.field-options');
            
            typeSelect.addEventListener('change', () => {
                if (typeSelect.value === 'select') {
                    optionsContainer.style.display = 'block';
                } else {
                    optionsContainer.style.display = 'none';
                }
            });
            
            container.querySelector('.remove-field').addEventListener('click', () => {
                container.remove();
                updateModel();
            });
            
            container.querySelector('.add-option').addEventListener('click', () => {
                addOptionUI(container.querySelector('.options-container'));
                updateModel();
            });
            
            return container;
        }

        // Add option UI element
        function addOptionUI(container) {
            const template = document.getElementById('option-template');
            const optionEl = template.content.cloneNode(true);
            const optionContainer = container.appendChild(optionEl).querySelector('.field-row');
            
            optionContainer.querySelector('.remove-option').addEventListener('click', () => {
                optionContainer.remove();
                updateModel();
            });
            
            return optionContainer;
        }

        // Add prompt UI element
        function addPromptUI() {
            const template = document.getElementById('prompt-template');
            const promptEl = template.content.cloneNode(true);
            const container = promptChainContainerEl.appendChild(promptEl).querySelector('.prompt-chain-item');
            
            container.querySelector('.remove-btn').addEventListener('click', () => {
                container.remove();
                updateModel();
            });
            
            return container;
        }

        // Update type selector
        function updateTypeSelector() {
            typeSelectorEl.innerHTML = '<option value="">Select a type...</option>';
            
            const typeField = currentFunction.fields.find(field => {
                return field.type === 'select' && 
                    (field.id === 'type' || field.id.toLowerCase().includes('type'));
            });
            
            if (typeField && typeField.options) {
                typeField.options.forEach(option => {
                    const optEl = document.createElement('option');
                    optEl.value = option;
                    optEl.textContent = option;
                    typeSelectorEl.appendChild(optEl);
                });
            }
        }

        // Update JSON preview
        function updateJsonPreview() {
            const json = JSON.stringify(currentFunction, null, 2);
            jsonPreviewEl.textContent = json;
        }

        // Update the data model from UI
        function updateModel() {
            if (!currentFunction) return;
            
            // Update basic info
            currentFunction.id = functionIdEl.value;
            currentFunction.url = functionUrlEl.value;
            currentFunction.multiPrompt = multiPromptEl.value === 'true';
            
            // Update fields
            currentFunction.fields = [];
            document.querySelectorAll('#fields-container > div').forEach(fieldContainer => {
                const fieldId = fieldContainer.querySelector('.field-id').value;
                const fieldLabel = fieldContainer.querySelector('.field-label').value;
                const fieldType = fieldContainer.querySelector('.field-type').value;
                
                if (!fieldId) return;
                
                const field = {
                    id: fieldId,
                    label: fieldLabel,
                    type: fieldType
                };
                
                // Add options for select fields
                if (fieldType === 'select') {
                    const options = [];
                    fieldContainer.querySelectorAll('.option-value').forEach(optionEl => {
                        if (optionEl.value) {
                            options.push(optionEl.value);
                        }
                    });
                    
                    if (options.length) {
                        field.options = options;
                    }
                }
                
                currentFunction.fields.push(field);
            });
            
            // Update defaults
            currentFunction.defaults = {};
            document.querySelectorAll('.default-value').forEach(defaultEl => {
                const fieldId = defaultEl.dataset.field;
                currentFunction.defaults[fieldId] = defaultEl.value;
            });
            
            // Update prompt chain
            currentFunction.promptChain = [];
            document.querySelectorAll('#prompt-chain-container .prompt-chain-item').forEach(promptContainer => {
                const promptId = promptContainer.querySelector('.prompt-id').value;
                const promptLabel = promptContainer.querySelector('.prompt-label').value;
                const promptSystem = promptContainer.querySelector('.prompt-system').value;
                const promptUser = promptContainer.querySelector('.prompt-user').value;
                const promptFormat = promptContainer.querySelector('.prompt-format').value;
                
                if (!promptId) return;
                
                currentFunction.promptChain.push({
                    id: promptId,
                    label: promptLabel,
                    system: promptSystem,
                    user: promptUser,
                    format: promptFormat
                });
            });
            
            // Update JSON preview
            updateJsonPreview();
        }

        // Create a new function
        function createNewFunction() {
            const newId = 'new-function-' + Math.floor(Math.random() * 1000);
            functionsRegistry[newId] = {
                url: '/editor/' + newId,
                multiPrompt: true,
                fields: [],
                defaults: {},
                promptChain: []
            };
            
            renderFunctionList();
            loadFunctionDetails(newId);
            
            // Select the new item in the list
            document.querySelector(`.registry-item[data-id="${newId}"]`).classList.add('active');
        }

        // Save the current function
        function saveFunction() {
            updateModel();
            
            const functionId = functionIdEl.value;
            if (!functionId) {
                alert('Function ID is required');
                return;
            }
            
            // Validate function
            const errors = validateFunction();
            if (errors.length > 0) {
                alert('Validation failed:\n- ' + errors.join('\n- '));
                return;
            }
            
            // If ID changed, need to update the registry
            if (currentFunction.id !== functionId) {
                delete functionsRegistry[currentFunction.id];
                const savedFunction = {...currentFunction};
                delete savedFunction.id; // Remove temporary id property
                functionsRegistry[functionId] = savedFunction;
                
                renderFunctionList();
                
                // Select the renamed item
                document.querySelector(`.registry-item[data-id="${functionId}"]`).classList.add('active');
            } else {
                const savedFunction = {...currentFunction};
                delete savedFunction.id; // Remove temporary id property
                functionsRegistry[functionId] = savedFunction;
            }
            
            alert('Function saved successfully!');
        }

        // Delete the current function
        function deleteFunction() {
            if (!currentFunction) return;
            
            if (confirm(`Are you sure you want to delete the function "${currentFunction.id}"?`)) {
                delete functionsRegistry[currentFunction.id];
                renderFunctionList();
                
                // Show empty state
                emptyStateEl.style.display = 'block';
                functionEditorEl.style.display = 'none';
                currentFunction = null;
            }
        }

        // Export function registry
        function exportRegistry() {
            const json = JSON.stringify(functionsRegistry, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'function-registry.json';
            a.click();
            
            URL.revokeObjectURL(url);
        }

        // Import function registry
        function importRegistry() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        // Validate the imported data structure
                        if (typeof imported !== 'object') {
                            throw new Error('Invalid registry format');
                        }
                        
                        // Confirm before overwriting
                        if (confirm('This will replace your current function registry. Continue?')) {
                            functionsRegistry = imported;
                            renderFunctionList();
                            
                            // Show empty state
                            emptyStateEl.style.display = 'block';
                            functionEditorEl.style.display = 'none';
                            currentFunction = null;
                            
                            alert('Registry imported successfully!');
                        }
                    } catch (err) {
                        alert('Error importing registry: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Add type-specific prompt
        function addTypeSpecificPrompt(type) {
            if (!type) return;
            
            if (!currentFunction.typeSpecificPrompts) {
                currentFunction.typeSpecificPrompts = {};
            }
            
            if (!currentFunction.typeSpecificPrompts[type]) {
                currentFunction.typeSpecificPrompts[type] = {
                    additional: []
                };
            }
            
            // Create a new prompt template
            const prompt = {
                id: 'typePrompt' + Math.floor(Math.random() * 1000),
                label: 'Type-Specific Prompt',
                system: 'You are creating content for ' + type,
                user: 'Write content specific to ' + type,
                format: 'Type-Specific Content:\n{content}'
            };
            
            currentFunction.typeSpecificPrompts[type].additional.push(prompt);
            renderTypeSpecificPrompts(type);
            updateJsonPreview();
        }

        // Render type-specific prompts
        function renderTypeSpecificPrompts(type) {
            typeSpecificContainerEl.innerHTML = '';
            
            if (!currentFunction.typeSpecificPrompts || 
                !currentFunction.typeSpecificPrompts[type] ||
                !currentFunction.typeSpecificPrompts[type].additional) {
                typeSpecificContainerEl.innerHTML = '<p>No type-specific prompts for this type yet.</p>';
                return;
            }
            
            const prompts = currentFunction.typeSpecificPrompts[type].additional;
            
            prompts.forEach((prompt, index) => {
                const template = document.getElementById('type-prompt-template');
                const promptEl = template.content.cloneNode(true);
                const container = typeSpecificContainerEl.appendChild(promptEl).querySelector('.prompt-chain-item');
                
                // Populate values
                container.querySelector('.type-prompt-id').value = prompt.id || '';
                container.querySelector('.type-prompt-id').dataset.index = index;
                
                container.querySelector('.type-prompt-label').value = prompt.label || '';
                container.querySelector('.type-prompt-label').dataset.index = index;
                
                container.querySelector('.type-prompt-system').value = prompt.system || '';
                container.querySelector('.type-prompt-system').dataset.index = index;
                
                container.querySelector('.type-prompt-user').value = prompt.user || '';
                container.querySelector('.type-prompt-user').dataset.index = index;
                
                container.querySelector('.type-prompt-format').value = prompt.format || '';
                container.querySelector('.type-prompt-format').dataset.index = index;
                
                // Add event listeners
                container.querySelector('.remove-btn').addEventListener('click', () => {
                    currentFunction.typeSpecificPrompts[type].additional.splice(index, 1);
                    renderTypeSpecificPrompts(type);
                    updateJsonPreview();
                });
                
                // Input change events
                container.querySelectorAll('input, textarea').forEach(input => {
                    input.addEventListener('input', () => {
                        updateTypeSpecificPrompt(type, index, input);
                    });
                });
            });
        }

        // Update type-specific prompt
        function updateTypeSpecificPrompt(type, index, input) {
            const prompt = currentFunction.typeSpecificPrompts[type].additional[index];
            
            if (input.classList.contains('type-prompt-id')) {
                prompt.id = input.value;
            } else if (input.classList.contains('type-prompt-label')) {
                prompt.label = input.value;
            } else if (input.classList.contains('type-prompt-system')) {
                prompt.system = input.value;
            } else if (input.classList.contains('type-prompt-user')) {
                prompt.user = input.value;
            } else if (input.classList.contains('type-prompt-format')) {
                prompt.format = input.value;
            }
            
            updateJsonPreview();
        }

        // Preview rendered prompt with sample data
        function previewRenderedPrompt(promptEl) {
            if (!currentFunction || !currentFunction.fields) return;
            
            // Get the prompt data
            const promptId = promptEl.querySelector('.prompt-id').value;
            const promptSystem = promptEl.querySelector('.prompt-system').value;
            const promptUser = promptEl.querySelector('.prompt-user').value;
            
            // Create sample data from fields
            const sampleData = {};
            currentFunction.fields.forEach(field => {
                if (field.type === 'select' && field.options && field.options.length > 0) {
                    sampleData[field.id] = field.options[0];
                } else {
                    sampleData[field.id] = `[Sample ${field.label}]`;
                }
            });
            
            // Add prevOutput for context
            sampleData.prevOutput = "[Previous output would appear here]";
            
            // Render the prompts
            let renderedSystem = promptSystem;
            let renderedUser = promptUser;
            
            // Replace variables
            Object.keys(sampleData).forEach(key => {
                const regex = new RegExp(`{${key}}`, 'g');
                renderedSystem = renderedSystem.replace(regex, sampleData[key]);
                renderedUser = renderedUser.replace(regex, sampleData[key]);
            });
            
            // Handle conditionals in a simple way
            // This is a simplified version - a real implementation would need more logic
            const conditionalRegex = /{(\w+), select, ([^}]*)}/g;
            renderedSystem = renderedSystem.replace(conditionalRegex, (match, key, options) => {
                // For this simple preview, just return the first option
                const firstOption = options.split(' ')[0];
                return `[Conditional: ${firstOption}]`;
            });
            
            renderedUser = renderedUser.replace(conditionalRegex, (match, key, options) => {
                const firstOption = options.split(' ')[0];
                return `[Conditional: ${firstOption}]`;
            });
            
            // Show the preview
            let previewContainer = promptEl.querySelector('.prompt-preview-container');
            
            if (!previewContainer) {
                previewContainer = document.createElement('div');
                previewContainer.className = 'prompt-preview-container';
                promptEl.appendChild(previewContainer);
            }
            
            previewContainer.innerHTML = `
                <h4>Preview for "${promptId}"</h4>
                <div class="preview-box">
                    <strong>System:</strong> ${renderedSystem}
                </div>
                <div class="preview-box">
                    <strong>User:</strong> ${renderedUser}
                </div>
            `;
        }

        // Preview all prompts
        function previewAllPrompts() {
            document.querySelectorAll('#prompt-chain-container .prompt-chain-item').forEach(promptEl => {
                previewRenderedPrompt(promptEl);
            });
        }

        // Validate function
        function validateFunction() {
            const errors = [];
            
            // Check basic info
            if (!functionIdEl.value) {
                errors.push('Function ID is required');
            }
            
            if (!functionUrlEl.value) {
                errors.push('URL path is required');
            }
            
            // Check fields
            const fieldIds = new Set();
            document.querySelectorAll('#fields-container > div').forEach(fieldContainer => {
                const fieldId = fieldContainer.querySelector('.field-id').value;
                const fieldLabel = fieldContainer.querySelector('.field-label').value;
                
                if (!fieldId) {
                    errors.push('Field ID is required for all fields');
                } else if (fieldIds.has(fieldId)) {
                    errors.push(`Duplicate field ID: ${fieldId}`);
                } else {
                    fieldIds.add(fieldId);
                }
                
                if (!fieldLabel) {
                    errors.push(`Label is required for field: ${fieldId}`);
                }
                
                // Check select fields have options
                const fieldType = fieldContainer.querySelector('.field-type').value;
                if (fieldType === 'select') {
                    const optionsCount = fieldContainer.querySelectorAll('.option-value').length;
                    if (optionsCount === 0) {
                        errors.push(`Select field "${fieldId}" needs at least one option`);
                    }
                }
            });
            
            // Check prompt chain
            const promptIds = new Set();
            document.querySelectorAll('#prompt-chain-container .prompt-chain-item').forEach(promptContainer => {
                const promptId = promptContainer.querySelector('.prompt-id').value;
                
                if (!promptId) {
                    errors.push('Prompt ID is required for all prompts');
                } else if (promptIds.has(promptId)) {
                    errors.push(`Duplicate prompt ID: ${promptId}`);
                } else {
                    promptIds.add(promptId);
                }
            });
            
            return errors;
        }

        // Generate documentation for the function
        function generateDocumentation() {
            if (!currentFunction) return '';
            
            let doc = `# ${currentFunction.id} Function Documentation\n\n`;
            
            // Basic info
            doc += `## Overview\n`;
            doc += `- **URL Path:** ${currentFunction.url}\n`;
            doc += `- **Multi-Prompt:** ${currentFunction.multiPrompt ? 'Yes' : 'No'}\n\n`;
            
            // Fields
            if (currentFunction.fields && currentFunction.fields.length > 0) {
                doc += `## Input Fields\n\n`;
                
                currentFunction.fields.forEach(field => {
                    doc += `### ${field.label} (${field.id})\n`;
                    doc += `- **Type:** ${field.type}\n`;
                    
                    if (field.type === 'select' && field.options) {
                        doc += `- **Options:** ${field.options.join(', ')}\n`;
                    }
                    
                    if (currentFunction.defaults && currentFunction.defaults[field.id] !== undefined) {
                        doc += `- **Default:** ${currentFunction.defaults[field.id]}\n`;
                    }
                    
                    doc += `\n`;
                });
            }
            
            // Prompt Chain
            if (currentFunction.promptChain && currentFunction.promptChain.length > 0) {
                doc += `## Prompt Chain\n\n`;
                
                currentFunction.promptChain.forEach((prompt, index) => {
                    doc += `### ${index + 1}. ${prompt.label} (${prompt.id})\n`;
                    doc += `- **System Message:** \`${prompt.system}\`\n`;
                    doc += `- **User Message:** \`${prompt.user}\`\n`;
                    doc += `- **Format:** \`${prompt.format}\`\n\n`;
                });
            }
            
            // Type-Specific Prompts
            if (currentFunction.typeSpecificPrompts) {
                doc += `## Type-Specific Features\n\n`;
                
                Object.keys(currentFunction.typeSpecificPrompts).forEach(type => {
                    doc += `### For ${type}\n\n`;
                    
                    const typePrompts = currentFunction.typeSpecificPrompts[type].additional;
                    if (typePrompts && typePrompts.length > 0) {
                        typePrompts.forEach(prompt => {
                            doc += `#### ${prompt.label} (${prompt.id})\n`;
                            doc += `- **System Message:** \`${prompt.system}\`\n`;
                            doc += `- **User Message:** \`${prompt.user}\`\n`;
                            doc += `- **Format:** \`${prompt.format}\`\n\n`;
                        });
                    }
                });
            }
            
            return doc;
        }

        // Download the documentation
        function downloadDocumentation() {
            if (!currentFunction) return;
            
            const doc = generateDocumentation();
            const blob = new Blob([doc], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentFunction.id}-documentation.md`;
            a.click();
            
            URL.revokeObjectURL(url);
        }

        // Event listeners setup
        function setupEventListeners() {
            // Tab switching
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Hide all tab content
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Show content for active tab
                    const activeContent = document.querySelector(`.tab-content[data-tab-content="${tab.dataset.tab}"]`);
                    if (activeContent) {
                        activeContent.classList.add('active');
                    }
                });
            });
            
            // Create new function
            addNewBtnEl.addEventListener('click', createNewFunction);
            createNewBtnEl.addEventListener('click', createNewFunction);
            
            // Save function
            saveBtnEl.addEventListener('click', saveFunction);
            
            // Delete function
            deleteBtnEl.addEventListener('click', deleteFunction);
            
            // Export/Import registry
            exportBtnEl.addEventListener('click', exportRegistry);
            importBtnEl.addEventListener('click', importRegistry);
            
            // Generate documentation
            generateDocsBtnEl.addEventListener('click', downloadDocumentation);
            
            // Add field
            addFieldBtnEl.addEventListener('click', () => {
                addFieldUI();
                updateModel();
            });
            
            // Add prompt
            addPromptBtnEl.addEventListener('click', () => {
                addPromptUI();
                updateModel();
            });
            
            // Preview all prompts
            previewAllPromptsBtn.addEventListener('click', previewAllPrompts);
            
            // Input change events for all form elements
            document.addEventListener('input', event => {
                if (event.target.closest('#function-editor')) {
                    updateModel();
                }
            });
            
            // Type selector change
            typeSelectorEl.addEventListener('change', () => {
                const selectedType = typeSelectorEl.value;
                if (selectedType) {
                    renderTypeSpecificPrompts(selectedType);
                } else {
                    typeSpecificContainerEl.innerHTML = '<p>Select a type to manage type-specific prompts.</p>';
                }
            });
            
            // Add type-specific prompt
            addTypePromptBtnEl.addEventListener('click', () => {
                const type = typeSelectorEl.value;
                if (type) {
                    addTypeSpecificPrompt(type);
                } else {
                    alert('Please select a type first');
                }
            });
            
            // Search functionality
            searchInputEl.addEventListener('input', () => {
                searchFunctions(searchInputEl.value);
            });
        }

        // Enhanced features for usability
        function enhanceUX() {
            // Add keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + S to save
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    if (currentFunction) {
                        saveFunction();
                    }
                }
                
                // Ctrl/Cmd + N for new function
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    createNewFunction();
                }
            });
            
            // Add drag and drop support for prompt chain items
            enablePromptDragAndDrop();
        }

        // Enable drag and drop for prompt chain items
        function enablePromptDragAndDrop() {
            let draggedItem = null;
            
            document.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('drag-handle')) {
                    draggedItem = e.target.closest('.prompt-chain-item');
                    draggedItem.style.opacity = '0.5';
                    
                    // Create a custom ghost image
                    const ghost = draggedItem.cloneNode(true);
                    ghost.style.position = 'absolute';
                    ghost.style.top = '-1000px';
                    document.body.appendChild(ghost);
                    
                    // Setup the drag operation
                    document.addEventListener('mousemove', handleDragMove);
                    document.addEventListener('mouseup', handleDragEnd);
                }
            });
            
            function handleDragMove(e) {
                if (!draggedItem) return;
                
                // Get the item below the cursor
                const belowElement = document.elementFromPoint(e.clientX, e.clientY);
                const targetItem = belowElement?.closest('.prompt-chain-item');
                
                if (targetItem && targetItem !== draggedItem) {
                    // Get the position of the target item
                    const targetRect = targetItem.getBoundingClientRect();
                    const targetMiddle = targetRect.top + targetRect.height / 2;
                    
                    if (e.clientY < targetMiddle) {
                        // Insert before target
                        promptChainContainerEl.insertBefore(draggedItem, targetItem);
                    } else {
                        // Insert after target
                        promptChainContainerEl.insertBefore(draggedItem, targetItem.nextSibling);
                    }
                    
                    // Update the model after reordering
                    updateModel();
                }
            }
            
            function handleDragEnd() {
                if (draggedItem) {
                    draggedItem.style.opacity = '1';
                    draggedItem = null;
                    
                    // Remove the ghost image and event listeners
                    const ghost = document.querySelector('.prompt-chain-item[style*="position: absolute"]');
                    if (ghost) {
                        document.body.removeChild(ghost);
                    }
                    
                    document.removeEventListener('mousemove', handleDragMove);
                    document.removeEventListener('mouseup', handleDragEnd);
                }
            }
        }

        // Call enhanceUX during initialization
        enhanceUX();

        // Initialize the app
        init();

      </script>

    <!-- Additional features that could be added:
    1. Multi-user collaboration features
    2. Version history tracking
    3. Function templates and presets
    4. Advanced conditional preview
    5. Syntax highlighting for prompts
    6. Integration with external APIs
    -->
</body>
</html>
